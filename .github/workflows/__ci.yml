---
name: '"CI" Runner'

on:
  workflow_call:
    inputs:
      build-branch:
        description: The branch to build from
        required: false
        type: string
      build-type:
        description: The type of build to perform ("python", "node")
        required: false
        type: string
      event-name:
        description: Name of the event which triggered the workflow
        required: true
        type: string
      node-build-directory:
        description: The directory to build the Node project in
        required: false
        type: string
        default: .
      path-to-__version__-file:
        description: The path to a Python file containing a `__version__` variable
        required: false
        type: string
      python-version:
        description: The Python version to build with
        required: false
        type: string
        default: '3.11'
      unit-test:
        description: Whether to run unit tests
        required: false
        type: string
        default: 'false'
      update-json-file-path:
        description: The path to a JSON file containing a `version` top level key
        required: false
        type: string
      update-pyproject-toml:
        description: Update the pyproject.toml version
        required: false
        type: string
        default: 'true'
      update-yaml-file-path:
        description: The path to a YAML file containing a `version` variable
        required: false
        type: string
      workflow-dispatch-env:
        description: The environment passed in from a workflow_dispatch event
        required: false
        type: string

jobs:
  ci-validation:
    name: 'CI: Validation'
    uses: ./.github/workflows/__ci_validation.yml
    with:
      build-branch: ${{ inputs.build-branch }}
      build-type: ${{ inputs.build-type }}
      python-version: ${{ inputs.python-version }}
      unit-test: ${{ inputs.unit-test }}

  ci-deployment:
    name: 'CI: Deployment'
    needs: ci-validation
    if: inputs.event-name == 'push' || inputs.workflow-dispatch-env == 'production'
    uses: ./.github/workflows/__ci_deployment.yml
    with:
      build-branch: ${{ inputs.build-branch }}
      build-type: ${{ inputs.build-type }}
      event-name: ${{ inputs.event-name }}
      node-build-directory: ${{ inputs.node-build-directory }}
      path-to-__version__-file: ${{ inputs.path-to-__version__-file }}
      python-version: ${{ inputs.python-version }}
      unit-test: ${{ inputs.unit-test }}
      update-json-file-path: ${{ inputs.update-json-file-path }}
      update-pyproject-toml: ${{ inputs.update-pyproject-toml }}
      update-yaml-file-path: ${{ inputs.update-yaml-file-path }}
      workflow-dispatch-env: ${{ inputs.workflow-dispatch-env }}
